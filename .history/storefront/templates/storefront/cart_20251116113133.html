{% extends "storefront/base.html" %}
{% load static %}

{% block title %}Your Cart{% endblock %}

{% block extra_css %}
<style>
  .cart-container {
    max-width: 1400px;
    margin: 0 auto;
  }

  .cart-header {
    margin-bottom: 40px;
  }

  .cart-header h1 {
    font-size: 32px;
    color: #333;
    margin-bottom: 10px;
  }

  .cart-header p {
    color: #666;
    font-size: 16px;
  }

  .cart-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
    align-items: start;
  }

  .cart-items {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }

  .cart-items-header {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 50px;
    padding: 20px 25px;
    border-bottom: 2px solid #f0f0f0;
    font-weight: 600;
    color: #666;
    font-size: 14px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .cart-item {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr 1fr 50px;
    align-items: center;
    padding: 35px 25px;
    border-bottom: 1px solid #f0f0f0;
    transition: background 0.3s;
    gap: 30px;
  }

  .cart-item:hover {
    background: #f9f9f9;
  }

  .item-info {
    display: flex;
    gap: 20px;
    align-items: center;
  }

  .item-image {
    width: 100px;
    height: 100px;
    border-radius: 10px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 40px;
    flex-shrink: 0;
    overflow: hidden;
  }

  .item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-image svg {
    width: 60px;
    height: 60px;
    opacity: 0.15;
  }

  .item-details h3 {
    font-size: 18px;
    color: #333;
    margin-bottom: 8px;
    font-weight: 600;
  }

  .item-details p {
    font-size: 14px;
    color: #666;
    margin-bottom: 4px;
  }

  .item-stock {
    font-size: 13px;
    color: #4CAF50;
    font-weight: 600;
  }

  .item-stock.low {
    color: #ff9800;
  }

  .item-stock.out {
    color: #e53935;
  }

  .item-price {
    font-size: 20px;
    font-weight: 700;
    color: #333;
  }

  .quantity-control {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .qty-btn {
    width: 32px;
    height: 32px;
    border: 1px solid #ddd;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 18px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  .qty-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .qty-btn:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .qty-input {
    width: 50px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 8px;
    font-weight: 600;
  }

  .item-total {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
  }

  .remove-btn {
    background: none;
    border: none;
    color: #999;
    font-size: 24px;
    cursor: pointer;
    transition: all 0.3s;
    padding: 5px;
  }

  .remove-btn:hover {
    color: #e53935;
    transform: scale(1.2);
  }

  .cart-summary {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    position: sticky;
    top: 100px;
  }

  .cart-summary h2 {
    font-size: 22px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
  }

  .promo-section {
    margin-bottom: 25px;
  }

  .promo-input-group {
    display: flex;
    gap: 10px;
  }

  .promo-input-group input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
  }

  .promo-input-group input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  .apply-promo-btn {
    padding: 12px 20px;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }

  .apply-promo-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    color: #666;
    font-size: 15px;
  }

  .summary-row.discount {
    color: #4CAF50;
  }

  .summary-row.total {
    margin-top: 20px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
    font-size: 24px;
    font-weight: 700;
    color: #333;
  }

  .checkout-btn {
    width: 100%;
    padding: 16px;
    background: #5568d3;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.3s;
  }

  .checkout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  .checkout-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .continue-shopping {
    display: block;
    text-align: center;
    margin-top: 15px;
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s;
  }

  .continue-shopping:hover {
    color: #5568d3;
  }

  .secure-checkout-badge {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    margin-top: 15px;
    color: #666;
    font-size: 13px;
  }

  .empty-cart {
    text-align: center;
    padding: 80px 20px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }

  .empty-cart-icon {
    font-size: 120px;
    margin-bottom: 20px;
    opacity: 0.3;
  }

  .empty-cart h2 {
    font-size: 28px;
    color: #333;
    margin-bottom: 15px;
  }

  .empty-cart p {
    color: #666;
    font-size: 16px;
    margin-bottom: 30px;
  }

  .shop-now-btn {
    display: inline-block;
    padding: 14px 40px;
    background: #5568d3;
    color: white;
    text-decoration: none;
    border-radius: 8px;
    font-weight: 600;
    font-size: 16px;
    transition: all 0.3s;
  }

  .shop-now-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
  }

  .recommendations-section {
    margin-top: 50px;
  }

  .recommendations-section h2 {
    font-size: 28px;
    color: #333;
    margin-bottom: 30px;
    text-align: center;
  }

  .recommendations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 25px;
  }

  .recommendation-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    transition: all 0.3s;
  }

  .recommendation-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  .recommendation-image {
    width: 100%;
    height: 200px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 60px;
  }

  .recommendation-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .recommendation-info {
    padding: 20px;
  }

  .recommendation-info h3 {
    font-size: 16px;
    color: #333;
    margin-bottom: 10px;
    font-weight: 600;
  }

  .recommendation-price {
    font-size: 20px;
    font-weight: 700;
    color: #667eea;
    margin-bottom: 15px;
  }

  .add-to-cart-rec-btn {
    width: 100%;
    padding: 10px;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
  }

  .add-to-cart-rec-btn:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .complete-set-card {
    transition: all 0.3s;
  }

  .complete-set-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
    border-color: #667eea !important;
  }

  .item-complete-set {
    scrollbar-width: thin;
    scrollbar-color: #667eea #f0f0f0;
  }

  .item-complete-set::-webkit-scrollbar {
    height: 6px;
  }

  .item-complete-set::-webkit-scrollbar-track {
    background: #f0f0f0;
    border-radius: 3px;
  }

  .item-complete-set::-webkit-scrollbar-thumb {
    background: #667eea;
    border-radius: 3px;
  }

  @media (max-width: 968px) {
    .cart-content {
      grid-template-columns: 1fr;
    }

    .cart-summary {
      position: static;
    }

    .cart-items-header {
      display: none;
    }

    .cart-item {
      grid-template-columns: 1fr;
      gap: 15px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .item-info {
      flex-direction: column;
      text-align: center;
    }

    .quantity-control {
      justify-content: center;
    }

    .recommendations-grid {
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="cart-container">
  <div class="cart-header">
    <h1>Shopping Cart</h1>
    <p>{% if order_items %}{{ order_items|length }} item{{ order_items|length|pluralize }} in your cart{% else %}Your cart is empty{% endif %}</p>
  </div>

  {% if order_items %}
  <div class="cart-content">
    <div class="cart-items">
      <div class="cart-items-header">
        <div>Product</div>
        <div>Price</div>
        <div>Quantity</div>
        <div>Total</div>
        <div></div>
      </div>

      {% for item in order_items %}
      <div class="cart-item" data-item-id="{{ item.id }}">
        <div class="item-info">
          <div class="item-image">
            {% if item.product.image %}
              <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}">
            {% else %}
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#667eea"/>
              </svg>
            {% endif %}
          </div>
          <div class="item-details">
            <h3>{{ item.product.name }}</h3>
            {% if item.product.category %}
            <p>Category: {{ item.product.category.name }}{% if item.product.subcategory %} / {{ item.product.subcategory }}{% endif %}</p>
            {% endif %}
            {% if item.product.stock %}
            <span class="item-stock {% if item.product.stock == 0 %}out{% elif item.product.stock < 5 %}low{% endif %}">
              {% if item.product.stock > 0 %}
                {{ item.product.stock }} in stock
              {% else %}
                Out of stock
              {% endif %}
            </span>
            {% endif %}
          </div>
        </div>

        <div class="item-price">
          ${{ item.product.price|default:"29.99" }}
        </div>

        <div class="quantity-control">
          <form method="post" action="{% url 'storefront:cart_update' item.id %}" style="display: flex; align-items: center; gap: 10px;">
            {% csrf_token %}
            <button type="button" class="qty-btn" onclick="decrementCartQty(this)">‚àí</button>
            <input type="number" name="quantity" value="{{ item.quantity }}" min="1" max="99" class="qty-input" readonly>
            <button type="button" class="qty-btn" onclick="incrementCartQty(this)">+</button>
            <button type="submit" style="display: none;" class="update-qty-submit">Update</button>
          </form>
        </div>

        <div class="item-total">${{ item.total_price }}</div>

        <div>
          <form method="post" action="{% url 'storefront:cart_remove' item.id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="remove-btn" title="Remove item">√ó</button>
          </form>
        </div>
      </div>

      <!-- Complete the Set for this item -->
      {% if item.complete_the_set %}
      <div class="item-complete-set" style="grid-column: 1 / -1; padding: 0 25px 25px 25px; margin-top: -10px;">
        <h4 style="font-size: 13px; color: #000000; margin-bottom: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px;">
          Complete the Set:
        </h4>
        <div style="display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px;">
          {% for rec_product in item.complete_the_set %}
          <div class="complete-set-card" style="min-width: 90px; max-width: 90px; background: white; border-radius: 10px; padding: 10px; border: 1px solid #f0f0f0; transition: all 0.3s; cursor: pointer;">
            <a href="{% url 'storefront:product_detail' rec_product.id %}" style="text-decoration: none; color: inherit; display: block;">
              <div style="width: 70px; height: 70px; margin: 0 auto 8px; background: linear-gradient(135deg, #f5f7fa 0%, #e3e8f0 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                {% if rec_product.image %}
                  <img src="{{ rec_product.image.url }}" alt="{{ rec_product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
                {% else %}
                  <svg viewBox="0 0 24 24" fill="none" style="width: 35px; height: 35px; opacity: 0.3;">
                    <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#667eea"/>
                  </svg>
                {% endif %}
              </div>
              <h5 style="font-size: 11px; color: #333; margin-bottom: 4px; font-weight: 600; line-height: 1.3; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; min-height: 28px;">{{ rec_product.name }}</h5>
              <div style="font-size: 13px; font-weight: 700; color: #667eea;">${{ rec_product.price }}</div>
            </a>
          </div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      {% endfor %}
    </div>

    <div class="cart-summary">
      <h2>Order Summary</h2>

      <div class="promo-section">
        {% if promo_code %}
        <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: #dcfce7; border-radius: 8px; margin-bottom: 15px;">
          <span style="color: #166534; font-weight: 600;">‚úì Promo code "{{ promo_code }}" applied</span>
          <form method="post" action="{% url 'storefront:cart_apply_promo' %}" style="margin: 0;">
            {% csrf_token %}
            <input type="hidden" name="promo_code" value="">
            <button type="submit" style="background: none; border: none; color: #dc2626; cursor: pointer; font-weight: 600; text-decoration: underline;">Remove</button>
          </form>
        </div>
        {% else %}
        <form method="post" action="{% url 'storefront:cart_apply_promo' %}">
          {% csrf_token %}
          <div class="promo-input-group">
            <input type="text" name="promo_code" placeholder="Enter promo code" class="promo-input">
            <button type="submit" class="apply-promo-btn">Apply</button>
          </div>
        </form>
        {% endif %}
      </div>
      
      <div class="summary-row">
        <span>Subtotal ({{ order_items|length }} items)</span>
        <span id="subtotal">${{ subtotal|default:"89.97" }}</span>
      </div>

      {% if shipping > 0 %}
      <div class="summary-row">
        <span>Shipping</span>
        <span id="shipping">${{ shipping }}</span>
      </div>
      {% else %}
      <div class="summary-row" style="color: #4CAF50;">
        <span>Shipping</span>
        <span>FREE</span>
      </div>
      {% endif %}

      <div class="summary-row">
        <span>Tax</span>
        <span id="tax">${{ tax|default:"8.00" }}</span>
      </div>

      {% if discount %}
      <div class="summary-row discount">
        <span>Discount ({{ promo_code }})</span>
        <span>-${{ discount }}</span>
      </div>
      {% endif %}

      <div class="summary-row total">
        <span>Total</span>
        <span id="total">${{ total|default:"107.96" }}</span>
      </div>

      <button class="checkout-btn" onclick="window.location.href=`{% url 'storefront:checkout' %}`">
        Proceed to Checkout
      </button>

      <a href="{% url 'storefront:home' %}" class="continue-shopping">
        ‚Üê Continue Shopping
      </a>

      <div class="secure-checkout-badge">
        Secure Checkout
      </div>
    </div>
  </div>

  {% else %}
  <div class="empty-cart">
    <div class="empty-cart-icon">üõí</div>
    <h2>Your Cart is Empty</h2>
    <p>Looks like you haven't added anything to your cart yet.</p>
    <a href="{% url 'storefront:home' %}" class="shop-now-btn">Start Shopping</a>
  </div>
  {% endif %}

  <!-- DEBUG: Check if recommendations are passed -->
  <!-- recommended_products count: {{ recommended_products|length }} -->
  <!-- recommended_products exists: {{ recommended_products|yesno:"yes,no" }} -->
  
  {% if recommended_products %}
  <div class="recommendations-section">
    <h2>{% if order_items %}You May Also Like{% else %}Popular Products{% endif %}</h2>
    <div class="recommendations-grid">
      {% for product in recommended_products %}
      <div class="recommendation-card">
        <a href="{% url 'storefront:product_detail' product.id %}" style="text-decoration: none; color: inherit;">
          <div class="recommendation-image">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}">
            {% else %}
              üì¶
            {% endif %}
          </div>
          <div class="recommendation-info">
            <h3>{{ product.name }}</h3>
            <div class="recommendation-price">${{ product.price|default:"29.99" }}</div>
          </div>
        </a>
        <form method="post" action="{% url 'storefront:cart_add' product.id %}" style="padding: 0 20px 20px;">
          {% csrf_token %}
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="add-to-cart-rec-btn">
            Add to Cart
          </button>
        </form>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
  function incrementCartQty(button) {
    const form = button.closest('form');
    const input = form.querySelector('.qty-input');
    const currentValue = parseInt(input.value);
    if (currentValue < 99) {
      input.value = currentValue + 1;
      form.querySelector('.update-qty-submit').click();
    }
  }

  function decrementCartQty(button) {
    const form = button.closest('form');
    const input = form.querySelector('.qty-input');
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
      input.value = currentValue - 1;
      form.querySelector('.update-qty-submit').click();
    }
  }
</script>
{% endblock %}