{% extends "base.html" %}
{% load static %}

{% block title %}My Account - AuroraMart{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 1rem;">
    <h1 class="text-3xl font-bold mb-8">My Account</h1>

    <div style="display: grid; grid-template-columns: 250px 1fr; gap: 2rem;">
        <!-- Sidebar Navigation -->
        <aside>
            <div class="card" style="padding: 1rem;">
                <nav style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <a href="#profile" onclick="showTab('profile')" id="tab-profile" class="account-tab active" style="padding: 0.75rem; border-radius: 0.5rem; text-decoration: none; color: inherit;">
                        Profile Information
                    </a>
                    <a href="#orders" onclick="showTab('orders')" id="tab-orders" class="account-tab" style="padding: 0.75rem; border-radius: 0.5rem; text-decoration: none; color: inherit;">
                        Order History
                    </a>
                    <a href="#preferences" onclick="showTab('preferences')" id="tab-preferences" class="account-tab" style="padding: 0.75rem; border-radius: 0.5rem; text-decoration: none; color: inherit;">
                        AI Preferences
                    </a>
                </nav>
            </div>
        </aside>

        <!-- Main Content -->
        <div>
            <!-- Profile Information -->
            <div id="content-profile" class="tab-content">
                <div class="card" style="padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h2 class="text-xl font-bold mb-4">Profile Information</h2>
                    
                    <form method="POST" action="{% url 'update_profile' %}">
                        {% csrf_token %}
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">First Name</label>
                                <input type="text" name="first_name" class="form-input" value="{{ user.first_name }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Last Name</label>
                                <input type="text" name="last_name" class="form-input" value="{{ user.last_name }}">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email</label>
                            <input type="email" name="email" class="form-input" value="{{ user.email }}" readonly>
                        </div>

                        {% if user.customer %}
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Age</label>
                                <input type="number" name="age" class="form-input" value="{{ user.customer.age }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Gender</label>
                                <select name="gender" class="form-select">
                                    <option value="Male" {% if user.customer.gender == 'Male' %}selected{% endif %}>Male</option>
                                    <option value="Female" {% if user.customer.gender == 'Female' %}selected{% endif %}>Female</option>
                                    <option value="Other" {% if user.customer.gender == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Location</label>
                                <input type="text" name="location" class="form-input" value="{{ user.customer.location }}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Income Level</label>
                                <select name="income_level" class="form-select">
                                    <option value="Low" {% if user.customer.income_level == 'Low' %}selected{% endif %}>Low</option>
                                    <option value="Medium" {% if user.customer.income_level == 'Medium' %}selected{% endif %}>Medium</option>
                                    <option value="High" {% if user.customer.income_level == 'High' %}selected{% endif %}>High</option>
                                </select>
                            </div>
                        </div>
                        {% endif %}

                        <button type="submit" class="btn btn-primary mt-4">Save Changes</button>
                    </form>
                </div>

                <!-- Delete Account -->
                <div class="card" style="padding: 1.5rem; border: 1px solid #fee2e2;">
                    <h3 class="font-semibold mb-2" style="color: #991b1b;">Danger Zone</h3>
                    <p class="text-sm text-gray-600 mb-4">Once you delete your account, there is no going back.</p>
                    <form method="POST" action="{% url 'delete_account' %}" onsubmit="return confirm('Are you sure you want to delete your account? This action cannot be undone.');">
                        {% csrf_token %}
                        <button type="submit" class="btn" style="background: #fee2e2; color: #991b1b;">
                            Delete Account
                        </button>
                    </form>
                </div>
            </div>

            <!-- Order History -->
            <div id="content-orders" class="tab-content" style="display: none;">
                <div class="card" style="padding: 1.5rem;">
                    <h2 class="text-xl font-bold mb-4">Order History</h2>
                    
                    {% if orders %}
                    <div style="display: grid; gap: 1rem;">
                        {% for order in orders %}
                        <div style="border: 1px solid var(--border); border-radius: 0.5rem; padding: 1rem;">
                            <div class="flex justify-between items-center mb-3">
                                <div>
                                    <p class="font-semibold">Order #{{ order.id }}</p>
                                    <p class="text-sm text-gray-600">{{ order.created_at|date:"M d, Y" }}</p>
                                </div>
                                <div style="text-align: right;">
                                    <p class="font-bold text-lg">${{ order.total }}</p>
                                    <span class="stock-badge {% if order.status == 'delivered' %}stock-in{% elif order.status == 'pending' %}stock-low{% else %}stock-out{% endif %}">
                                        {{ order.status|title }}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid var(--border); padding-top: 1rem;">
                                {% for item in order.items.all %}
                                <div class="flex gap-2 mb-2">
                                    <img src="{{ item.product.image_url }}" alt="{{ item.product.name }}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 0.25rem;">
                                    <div>
                                        <p class="text-sm font-semibold">{{ item.product.name }}</p>
                                        <p class="text-sm text-gray-600">Qty: {{ item.quantity }} Ã— ${{ item.price }}</p>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 3rem;">
                        <p class="text-gray-500 mb-4">You haven't placed any orders yet.</p>
                        <a href="{% url 'products' %}" class="btn btn-primary">Start Shopping</a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- AI Preferences -->
            <div id="content-preferences" class="tab-content" style="display: none;">
                <div class="card" style="padding: 1.5rem;">
                    <h2 class="text-xl font-bold mb-4">AI Personalization</h2>
                    
                    {% if user.customer %}
                    <div style="background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(168, 85, 247, 0.1)); padding: 1.5rem; border-radius: 0.5rem; margin-bottom: 1.5rem;">
                        <h3 class="font-semibold mb-2">Your Predicted Category</h3>
                        <p class="text-2xl font-bold text-primary mb-2">{{ user.customer.predicted_category }}</p>
                        <p class="text-sm text-gray-600">Based on your profile, our AI recommends products from this category</p>
                    </div>
                    {% endif %}

                    <div class="mb-4">
                        <h3 class="font-semibold mb-3">How It Works</h3>
                        <ul style="list-style: disc; padding-left: 1.5rem; color: #64748b;">
                            <li>Our AI analyzes your demographics and preferences</li>
                            <li>We use decision tree classification to predict your interests</li>
                            <li>Association rules help us suggest complementary products</li>
                            <li>Your homepage is personalized based on these insights</li>
                        </ul>
                    </div>

                    <div style="border-top: 1px solid var(--border); padding-top: 1rem;">
                        <p class="text-sm text-gray-600">Want to update your preferences? Edit your profile information to get better recommendations.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    document.querySelectorAll('.account-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.fontWeight = 'normal';
    });
    
    document.getElementById('content-' + tabName).style.display = 'block';
    const activeTab = document.getElementById('tab-' + tabName);
    activeTab.classList.add('active');
    activeTab.style.fontWeight = '600';
}

// Show profile tab by default
showTab('profile');
</script>
{% endblock %}
