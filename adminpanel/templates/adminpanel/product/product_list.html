{% extends "adminpanel/base.html" %}

{% block title %}Products{% endblock %}
{% block page_title %}Products{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .header-actions {
        display: flex;
        gap: 12px;
    }

    .btn-add {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: #0f172a;
        color: white;
        text-decoration: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
    }

    .btn-add:hover {
        background: #1e293b;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(15,23,42,0.2);
    }

    .filters-bar {
        background: white;
        padding: 20px;
        border-radius: 12px;
        margin-bottom: 25px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .filters-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 15px;
        align-items: end;
    }

    @media (max-width: 768px) {
        .filters-grid {
            grid-template-columns: 1fr;
        }
    }

    .form-group {
        margin-bottom: 0;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #0f172a;
        font-size: 14px;
    }

    .form-group label i {
        color: #64748b;
        margin-right: 6px;
    }

    .form-control {
        width: 100%;
        padding: 10px 15px;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
    }

    .form-control:focus {
        outline: none;
        border-color: #64748b;
        box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
    }

    .products-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        border: 1px solid #e2e8f0;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    thead {
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
    }

    thead th {
        padding: 16px 20px;
        text-align: left;
        font-weight: 600;
        color: #64748b;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    tbody tr {
        border-bottom: 1px solid #f3f4f6;
        transition: background 0.2s ease;
    }

    tbody tr:hover {
        background: #f9fafb;
    }

    tbody td {
        padding: 18px 20px;
        color: #374151;
        font-size: 14px;
    }

    .product-name {
        font-weight: 600;
        color: #1f2937;
        display: block;
        margin-bottom: 4px;
    }

    .product-sku {
        font-size: 12px;
        color: #6b7280;
    }

    .badge {
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
    }

    .badge-success {
        background: #ecfdf5;
        color: #065f46;
    }

    .badge-warning {
        background: #fffbeb;
        color: #92400e;
    }

    .badge-danger {
        background: #fef2f2;
        color: #991b1b;
    }

    .badge-info {
        background: #f1f5f9;
        color: #64748b;
    }

    .price {
        font-weight: 700;
        color: #0f172a;
        font-size: 15px;
    }

    .rating {
        color: #64748b;
        font-weight: 600;
    }

    .actions {
        display: flex;
        gap: 8px;
    }

    .btn-icon {
        width: 36px;
        height: 36px;
        border-radius: 8px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #e2e8f0;
        background: white;
        color: #64748b;
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        font-size: 14px;
    }

    .btn-icon:hover {
        background: #f8fafc;
        color: #0f172a;
        border-color: #cbd5e1;
    }

    .btn-delete:hover {
        background: #fef2f2;
        color: #dc2626;
        border-color: #fecaca;
    }

    .btn-view {
        background: #dbeafe;
        color: #1e40af;
    }

    .btn-view:hover {
        background: #bfdbfe;
        transform: translateY(-2px);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        margin-top: 30px;
        padding: 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .pagination a, .pagination span {
        padding: 8px 16px;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
    }

    .pagination a {
        background: #f3f4f6;
        color: #374151;
    }

    .pagination a:hover {
        background: #3b82f6;
        color: white;
    }

    .pagination .current {
        background: #3b82f6;
        color: white;
    }

    .pagination .disabled {
        background: #f9fafb;
        color: #d1d5db;
        cursor: not-allowed;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
    }

    .empty-state h3 {
        font-size: 24px;
        color: #374151;
        margin-bottom: 10px;
    }

    .empty-state p {
        color: #6b7280;
        font-size: 16px;
    }

    .results-info {
        padding: 15px 20px;
        background: #f9fafb;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div></div>
    <div class="header-actions">
        <a href="{% url 'adminpanel:product_add' %}" class="btn-add">
            <i class="fas fa-plus"></i>
            Add Product
        </a>
    </div>
</div>

<div class="filters-bar">
    <form method="GET" action="{% url 'adminpanel:product_list' %}">
        <div class="filters-grid">
            <div class="form-group">
                <label for="search"><i class="fas fa-search"></i> Search</label>
                <input type="text" id="search" name="search" class="form-control" 
                       placeholder="Search by name, SKU, or description..." 
                       value="{{ search_query }}">
            </div>

            <div class="form-group">
                <label for="category"><i class="fas fa-folder"></i> Category</label>
                <select id="category" name="category" class="form-control">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {% if selected_category == category.id|stringformat:"s" %}selected{% endif %}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="sort"><i class="fas fa-sort"></i> Sort By</label>
                <select id="sort" name="sort" class="form-control">
                    <option value="-created_at" {% if sort_by == '-created_at' %}selected{% endif %}>Newest First</option>
                    <option value="created_at" {% if sort_by == 'created_at' %}selected{% endif %}>Oldest First</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                    <option value="-name" {% if sort_by == '-name' %}selected{% endif %}>Name (Z-A)</option>
                    <option value="-price" {% if sort_by == '-price' %}selected{% endif %}>Price (High-Low)</option>
                    <option value="price" {% if sort_by == 'price' %}selected{% endif %}>Price (Low-High)</option>
                    <option value="-rating" {% if sort_by == '-rating' %}selected{% endif %}>Rating (High-Low)</option>
                    <option value="rating" {% if sort_by == 'rating' %}selected{% endif %}>Rating (Low-High)</option>
                    <option value="stock" {% if sort_by == 'stock' %}selected{% endif %}>Stock (Low-High)</option>
                    <option value="-stock" {% if sort_by == '-stock' %}selected{% endif %}>Stock (High-Low)</option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary mt-20">Apply Filters</button>
    </form>
</div>

{% if page_obj %}
<div class="products-table">
    <div class="results-info">
        Showing {{ page_obj.start_index }} - {{ page_obj.end_index }} of {{ page_obj.paginator.count }} products
    </div>
    <table>
        <thead>
            <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Price</th>
                <th>Stock</th>
                <th>Rating</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for product in page_obj %}
            <tr>
                <td>
                    <span class="product-name">{{ product.name }}</span>
                    <span class="product-sku">SKU: {{ product.sku }}</span>
                </td>
                <td>
                    <span class="badge badge-info">{{ product.category.name }}</span>
                    {% if product.subcategory %}
                    <br><small style="color: #6b7280;">{{ product.subcategory }}</small>
                    {% endif %}
                </td>
                <td><span class="price">${{ product.price }}</span></td>
                <td>
                    {% if product.stock == 0 %}
                        <span class="badge badge-danger">Out of Stock</span>
                    {% elif product.is_low_stock %}
                        <span class="badge badge-warning">{{ product.stock }} units</span>
                    {% else %}
                        <span class="badge badge-success">{{ product.stock }} units</span>
                    {% endif %}
                </td>
                <td><span class="rating">{{ product.rating|floatformat:1 }}</span></td>
                <td>
                    {% if product.is_active %}
                        <span class="badge badge-success">Active</span>
                    {% else %}
                        <span class="badge badge-danger">Inactive</span>
                    {% endif %}
                </td>
                <td>
                    <div class="actions">
                        <a href="{% url 'adminpanel:product_detail' product.pk %}" class="btn-icon btn-view" title="View Details">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="{% url 'adminpanel:product_edit' product.pk %}" class="btn-icon" title="Edit Product">
                            <i class="fas fa-edit"></i>
                        </a>
                        <button class="btn-icon btn-delete" data-product-id="{{ product.pk }}" data-product-name="{{ product.name }}" title="Delete Product">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if page_obj.has_other_pages %}
<div class="pagination">
    {% if page_obj.has_previous %}
        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">« First</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">‹ Previous</a>
    {% else %}
        <span class="disabled">« First</span>
        <span class="disabled">‹ Previous</span>
    {% endif %}

    <span class="current">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

    {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Next ›</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_category %}&category={{ selected_category }}{% endif %}{% if sort_by %}&sort={{ sort_by }}{% endif %}">Last »</a>
    {% else %}
        <span class="disabled">Next ›</span>
        <span class="disabled">Last »</span>
    {% endif %}
</div>
{% endif %}

{% else %}
<div class="product-table-container">
    <div class="empty-state">
        <i class="fas fa-box-open" style="font-size: 64px; color: #e2e8f0; margin-bottom: 16px;"></i>
        <h3 style="font-size: 18px; font-weight: 600; color: #0f172a; margin-bottom: 8px;">No Products Found</h3>
        <p style="color: #64748b; font-size: 14px;">Try adjusting your search or filter criteria</p>
    </div>
</div>
{% endif %}

{% block extra_js %}
<script>
    // Use event delegation for delete buttons
    document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(e) {
            const deleteBtn = e.target.closest('.btn-delete');
            if (deleteBtn) {
                const productId = deleteBtn.dataset.productId;
                const productName = deleteBtn.dataset.productName;
                
                if (confirm(`Are you sure you want to delete "${productName}"?\n\nNote: This will NOT affect the storefront AI model, as the model uses historical transaction data, not current product listings.`)) {
                    // Create a form and submit it
                    const form = document.createElement('form');
                    form.method = 'POST';
                    form.action = `/adminpanel/products/${productId}/delete/`;
                    
                    // Add CSRF token
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]') || 
                                     document.querySelector('meta[name="csrf-token"]');
                    if (csrfToken) {
                        const csrfInput = document.createElement('input');
                        csrfInput.type = 'hidden';
                        csrfInput.name = 'csrfmiddlewaretoken';
                        csrfInput.value = csrfToken.content || csrfToken.value;
                        form.appendChild(csrfInput);
                    }
                    
                    document.body.appendChild(form);
                    form.submit();
                }
            }
        });
    });
</script>
{% endblock %}
{% endblock %}
