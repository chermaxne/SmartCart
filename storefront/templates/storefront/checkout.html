{% extends "storefront/base.html" %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
  .checkout-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .checkout-header {
    text-align: center;
    margin-bottom: 40px;
  }
  
  .checkout-header h1 {
    font-size: 32px;
    color: #333;
    margin-bottom: 10px;
  }
  
  .checkout-header p {
    color: #666;
    font-size: 16px;
  }
  
  .progress-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 50px;
    position: relative;
  }
  
  .progress-bar::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e0e0e0;
    z-index: -1;
  }
  
  .progress-step {
    flex: 1;
    text-align: center;
    position: relative;
  }
  
  .step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    color: #999;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .progress-step.active .step-circle {
    background: #667eea;
    color: white;
  }
  
  .progress-step.completed .step-circle {
    background: #4CAF50;
    color: white;
  }
  
  .step-label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
  }
  
  .progress-step.active .step-label {
    color: #667eea;
    font-weight: 600;
  }
  
  .checkout-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
  }
  
  .checkout-form {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  
  .form-section {
    margin-bottom: 35px;
  }
  
  .form-section h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    color: #555;
    font-weight: 500;
    font-size: 14px;
  }
  
  label .required {
    color: #e53935;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  .order-summary {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    height: fit-content;
    position: sticky;
    top: 20px;
  }
  
  .order-summary h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .cart-item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .cart-item:last-child {
    border-bottom: none;
  }
  
  .item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    flex-shrink: 0;
  }
  
  .item-details {
    flex: 1;
  }
  
  .item-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }
  
  .item-quantity {
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
  }
  
  .item-price {
    font-weight: 600;
    color: #667eea;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    color: #666;
    font-size: 14px;
  }
  
  .summary-row.total {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #f0f0f0;
    font-size: 18px;
    font-weight: 700;
    color: #333;
  }
  
  .promo-code {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .promo-code input {
    flex: 1;
  }
  
  .apply-btn {
    padding: 12px 20px;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  
  .apply-btn:hover {
    background: #e0e0e0;
  }
  
  .payment-methods {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .payment-method {
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .payment-method:hover {
    border-color: #667eea;
  }
  
  .payment-method.active {
    border-color: #667eea;
    background: #f8f9ff;
  }
  
  .payment-method input[type="radio"] {
    display: none;
  }
  
  .payment-icon {
    font-size: 24px;
    margin-bottom: 5px;
  }
  
  .payment-label {
    font-size: 12px;
    font-weight: 600;
    color: #555;
  }
  
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-back {
    background: #f5f5f5;
    color: #333;
  }
  
  .btn-back:hover {
    background: #e0e0e0;
  }
  
  .btn-continue {
    background: #667eea;
    color: white;
  }
  
  .btn-continue:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-place-order {
    width: 100%;
    background: #4CAF50;
    color: white;
  }
  
  .btn-place-order:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
  }
  
  .secure-checkout {
    text-align: center;
    margin-top: 20px;
    color: #666;
    font-size: 13px;
  }
  
  .secure-checkout::before {
    content: 'üîí';
    margin-right: 5px;
  }
  
  .step-content {
    display: none;
  }
  
  .step-content.active {
    display: block;
  }
  
  @media (max-width: 968px) {
    .checkout-content {
      grid-template-columns: 1fr;
    }
    
    .order-summary {
      position: static;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .payment-methods {
      grid-template-columns: 1fr;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
  <div class="checkout-header">
    <h1>Secure Checkout</h1>
    <p>Complete your purchase in just a few steps</p>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Shipping</div>
    </div>
    <div class="progress-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Payment</div>
    </div>
    <div class="progress-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Review</div>
    </div>
  </div>

  <div class="checkout-content">
    <div class="checkout-form">
      <form id="checkoutForm" method="POST">
        {% csrf_token %}
        
        <!-- Step 1: Shipping Information -->
        <div class="step-content active" data-step="1">
          <div class="form-section">
            <h2>Shipping Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label>First Name <span class="required">*</span></label>
                <input type="text" name="first_name" required>
              </div>
              <div class="form-group">
                <label>Last Name <span class="required">*</span></label>
                <input type="text" name="last_name" required>
              </div>
            </div>
            
            <div class="form-group">
              <label>Email Address <span class="required">*</span></label>
              <input type="email" name="email" required>
            </div>
            
            <div class="form-group">
              <label>Phone Number <span class="required">*</span></label>
              <input type="tel" name="phone" required>
            </div>
            
            <div class="form-group">
              <label>Street Address <span class="required">*</span></label>
              <input type="text" name="address" required>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>City <span class="required">*</span></label>
                <input type="text" name="city" required>
              </div>
              <div class="form-group">
                <label>State/Province <span class="required">*</span></label>
                <input type="text" name="state" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>ZIP/Postal Code <span class="required">*</span></label>
                <input type="text" name="zip" required>
              </div>
              <div class="form-group">
                <label>Country <span class="required">*</span></label>
                <select name="country" required>
                  <option value="">Select Country</option>
                  <option value="US">United States</option>
                  <option value="CA">Canada</option>
                  <option value="UK">United Kingdom</option>
                  <option value="AU">Australia</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="saveAddress" name="save_address">
                <label for="saveAddress" style="margin: 0;">Save this address for future orders</label>
              </div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-back" onclick="window.location.href=`{% url 'storefront:home' %}`">
              ‚Üê Back to Cart
            </button>
            <button type="button" class="btn btn-continue" onclick="nextStep()">
              Continue to Payment ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 2: Payment Information -->
        <div class="step-content" data-step="2">
          <div class="form-section">
            <h2>Payment Method</h2>
            <div class="payment-methods">
              <label class="payment-method active">
                <input type="radio" name="payment_method" value="card" checked>
                <div class="payment-icon">üí≥</div>
                <div class="payment-label">Credit Card</div>
              </label>
              <label class="payment-method">
                <input type="radio" name="payment_method" value="paypal">
                <div class="payment-icon">üÖøÔ∏è</div>
                <div class="payment-label">PayPal</div>
              </label>
              <label class="payment-method">
                <input type="radio" name="payment_method" value="apple">
                <div class="payment-icon">üçé</div>
                <div class="payment-label">Apple Pay</div>
              </label>
            </div>
          </div>

          <div class="form-section" id="cardDetails">
            <h2>Card Details</h2>
            <div class="form-group">
              <label>Card Number <span class="required">*</span></label>
              <input type="text" name="card_number" placeholder="1234 5678 9012 3456" maxlength="19">
            </div>
            
            <div class="form-group">
              <label>Cardholder Name <span class="required">*</span></label>
              <input type="text" name="card_name" placeholder="John Doe">
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>Expiry Date <span class="required">*</span></label>
                <input type="text" name="expiry" placeholder="MM/YY" maxlength="5">
              </div>
              <div class="form-group">
                <label>CVV <span class="required">*</span></label>
                <input type="text" name="cvv" placeholder="123" maxlength="4">
              </div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-back" onclick="prevStep()">
              ‚Üê Back
            </button>
            <button type="button" class="btn btn-continue" onclick="nextStep()">
              Review Order ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 3: Review Order -->
        <div class="step-content" data-step="3">
          <div class="form-section">
            <h2>Review Your Order</h2>
            <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #333;">Shipping Address</h3>
              <p style="color: #666; line-height: 1.6;" id="reviewAddress">
                <!-- Will be filled by JavaScript -->
              </p>
            </div>
            
            <div style="background: #f8f9ff; padding: 20px; border-radius: 8px;">
              <h3 style="margin-bottom: 15px; color: #333;">Payment Method</h3>
              <p style="color: #666;" id="reviewPayment">
                <!-- Will be filled by JavaScript -->
              </p>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="agreeTerms" required>
              <label for="agreeTerms" style="margin: 0;">
                I agree to the <a href="#" style="color: #667eea;">Terms & Conditions</a>
              </label>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-back" onclick="prevStep()">
              ‚Üê Back
            </button>
            <button type="submit" class="btn btn-place-order">
              Place Order
            </button>
          </div>
          
          <div class="secure-checkout">
            Your payment information is secure and encrypted
          </div>
        </div>
      </form>
    </div>

    <div class="order-summary">
      <h2>Order Summary</h2>
      
      <div class="cart-items">
        {% if cart_items %}
          {% for item in cart_items %}
          <div class="cart-item">
            <div class="item-image">
              {% if item.product.image %}
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
              {% else %}
                üì¶
              {% endif %}
            </div>
            <div class="item-details">
              <div class="item-name">{{ item.product.name }}</div>
              <div class="item-quantity">Quantity: {{ item.quantity }}</div>
              <div class="item-price">${{ item.total_price }}</div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="cart-item">
            <div class="item-image">üì¶</div>
            <div class="item-details">
              <div class="item-name">Sample Product</div>
              <div class="item-quantity">Quantity: 1</div>
              <div class="item-price">$29.99</div>
            </div>
          </div>
          <div class="cart-item">
            <div class="item-image">üì±</div>
            <div class="item-details">
              <div class="item-name">Another Product</div>
              <div class="item-quantity">Quantity: 2</div>
              <div class="item-price">$59.98</div>
            </div>
          </div>
        {% endif %}
      </div>
      
      <div class="promo-code">
        <input type="text" placeholder="Promo code" id="promoInput">
        <button class="apply-btn" onclick="applyPromo()">Apply</button>
      </div>
      
      <div class="summary-row">
        <span>Subtotal</span>
        <span id="subtotal">${{ subtotal|default:"89.97" }}</span>
      </div>
      <div class="summary-row">
        <span>Shipping</span>
        <span id="shipping">${{ shipping|default:"9.99" }}</span>
      </div>
      <div class="summary-row">
        <span>Tax</span>
        <span id="tax">${{ tax|default:"8.00" }}</span>
      </div>
      <div class="summary-row" id="discountRow" style="display: none; color: #4CAF50;">
        <span>Discount</span>
        <span id="discount">-$0.00</span>
      </div>
      <div class="summary-row total">
        <span>Total</span>
        <span id="total">${{ total|default:"107.96" }}</span>
      </div>
    </div>
  </div>

  <!-- DEBUG INFO -->
  <!-- Cart items count: {{ cart_items|length }} -->
  <!-- Recommended products count: {{ recommended_products|length }} -->
  <!-- Recommended products type: {{ recommended_products }} -->
  
  <!-- AI-Powered Recommendations Section -->
  {% if recommended_products %}
  <div style="margin-top: 50px; max-width: 1200px; margin-left: auto; margin-right: auto;">
    <div style="text-align: center; margin-bottom: 30px;">
      <h2 style="font-size: 28px; color: #333; margin-bottom: 10px;">
        üéØ You Might Also Like
      </h2>
      <p style="color: #666; font-size: 16px;">
        Based on your cart, we recommend these products
      </p>
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px;">
      {% for product in recommended_products %}
      <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: all 0.3s;">
        <a href="{% url 'storefront:product_detail' product.id %}" style="text-decoration: none; color: inherit;">
          <div style="width: 100%; height: 200px; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); display: flex; align-items: center; justify-content: center; font-size: 60px;">
            {% if product.image %}
              <img src="{{ product.image.url }}" alt="{{ product.name }}" style="width: 100%; height: 100%; object-fit: cover;">
            {% else %}
              üì¶
            {% endif %}
          </div>
          <div style="padding: 20px;">
            <h3 style="font-size: 16px; color: #333; margin-bottom: 10px; font-weight: 600; min-height: 40px;">{{ product.name|truncatechars:50 }}</h3>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
              <span style="font-size: 20px; font-weight: 700; color: #667eea;">${{ product.price }}</span>
              <span style="color: #f59e0b; font-size: 14px;">‚≠ê {{ product.rating }}</span>
            </div>
          </div>
        </a>
        <form method="post" action="{% url 'storefront:cart_add' product.id %}" style="padding: 0 20px 20px;">
          {% csrf_token %}
          <input type="hidden" name="quantity" value="1">
          <button type="submit" style="width: 100%; padding: 10px; background: #f5f5f5; color: #333; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
            Add to Cart
          </button>
        </form>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}
</div>

<script>
  let currentStep = 1;

  function nextStep() {
    if (validateStep(currentStep)) {
      document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
      
      document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
      
      currentStep++;
      
      document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
      document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
      
      if (currentStep === 3) {
        updateReview();
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function prevStep() {
    document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
    
    currentStep--;
    
    document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function validateStep(step) {
    const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
    const inputs = stepContent.querySelectorAll('input[required], select[required]');
    
    for (let input of inputs) {
      if (!input.value) {
        input.focus();
        alert('Please fill in all required fields');
        return false;
      }
    }
    return true;
  }

  function updateReview() {
    const form = document.getElementById('checkoutForm');
    const address = `${form.first_name.value} ${form.last_name.value}<br>
                     ${form.address.value}<br>
                     ${form.city.value}, ${form.state.value} ${form.zip.value}<br>
                     ${form.country.options[form.country.selectedIndex].text}<br>
                     ${form.phone.value}`;
    
    document.getElementById('reviewAddress').innerHTML = address;
    
    const paymentMethod = form.payment_method.value;
    let paymentText = '';
    
    if (paymentMethod === 'card') {
      const cardNumber = form.card_number.value;
      const lastFour = cardNumber.slice(-4);
      paymentText = `Credit Card ending in ${lastFour}`;
    } else if (paymentMethod === 'paypal') {
      paymentText = 'PayPal';
    } else {
      paymentText = 'Apple Pay';
    }
    
    document.getElementById('reviewPayment').textContent = paymentText;
  }

  // Payment method selection
  document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
      this.classList.add('active');
      this.querySelector('input[type="radio"]').checked = true;
      
      const cardDetails = document.getElementById('cardDetails');
      if (this.querySelector('input').value === 'card') {
        cardDetails.style.display = 'block';
      } else {
        cardDetails.style.display = 'none';
      }
    });
  });

  // Card number formatting
  document.querySelector('input[name="card_number"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
  });

  // Expiry date formatting
  document.querySelector('input[name="expiry"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
      value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value;
  });
  
</script>
{% endblock %}