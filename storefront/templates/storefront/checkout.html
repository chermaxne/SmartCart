{% extends "storefront/base.html" %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block extra_css %}
<style>
  .checkout-container {
    max-width: 1200px;
    margin: 40px auto;
    padding: 0 20px;
  }
  
  .checkout-header {
    text-align: center;
    margin-bottom: 40px;
  }
  
  .checkout-header h1 {
    font-size: 32px;
    color: #333;
    margin-bottom: 10px;
  }
  
  .checkout-header p {
    color: #666;
    font-size: 16px;
  }
  
  .progress-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 50px;
    position: relative;
  }
  
  .progress-bar::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e0e0e0;
    z-index: -1;
  }
  
  .progress-step {
    flex: 1;
    text-align: center;
    position: relative;
  }
  
  .step-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e0e0e0;
    color: #999;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 10px;
    font-weight: 600;
    transition: all 0.3s;
  }
  
  .progress-step.active .step-circle {
    background: #667eea;
    color: white;
  }
  
  .progress-step.completed .step-circle {
    background: #4CAF50;
    color: white;
  }
  
  .step-label {
    font-size: 14px;
    color: #666;
    font-weight: 500;
  }
  
  .progress-step.active .step-label {
    color: #667eea;
    font-weight: 600;
  }
  
  .checkout-content {
    display: grid;
    grid-template-columns: 1fr 400px;
    gap: 30px;
  }
  
  .checkout-form {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
  }
  
  .form-section {
    margin-bottom: 35px;
  }
  
  .form-section h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
  }
  
  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 15px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  label {
    display: block;
    margin-bottom: 6px;
    color: #555;
    font-weight: 500;
    font-size: 14px;
  }
  
  label .required {
    color: #e53935;
  }
  
  input, select, textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 14px;
    transition: border-color 0.3s;
    box-sizing: border-box;
  }
  
  input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }

  input.error {
    border-color: #e53935;
  }

  input.error:focus {
    box-shadow: 0 0 0 3px rgba(229, 57, 53, 0.1);
  }

  .error-message {
    display: block;
    color: #e53935;
    font-size: 12px;
    margin-top: 5px;
    min-height: 18px;
  }
  
  .checkbox-group {
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .checkbox-group input[type="checkbox"] {
    width: auto;
    margin: 0;
  }
  
  .order-summary {
    background: white;
    border-radius: 12px;
    padding: 30px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    height: fit-content;
    position: sticky;
    top: 20px;
  }
  
  .order-summary h2 {
    font-size: 20px;
    color: #333;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #f0f0f0;
  }
  
  .cart-item {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f0f0f0;
  }
  
  .cart-item:last-child {
    border-bottom: none;
  }
  
  .item-image {
    width: 80px;
    height: 80px;
    border-radius: 8px;
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
    flex-shrink: 0;
  }
  
  .item-details {
    flex: 1;
  }
  
  .item-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 5px;
  }
  
  .item-quantity {
    font-size: 13px;
    color: #666;
    margin-bottom: 5px;
  }
  
  .item-price {
    font-weight: 600;
    color: #667eea;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    color: #666;
    font-size: 14px;
  }
  
  .summary-row.total {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 2px solid #f0f0f0;
    font-size: 18px;
    font-weight: 700;
    color: #333;
  }
  
  .promo-code {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
  }
  
  .promo-code input {
    flex: 1;
  }
  
  .apply-btn {
    padding: 12px 20px;
    background: #f5f5f5;
    color: #333;
    border: 1px solid #ddd;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.3s;
  }
  
  .apply-btn:hover {
    background: #e0e0e0;
  }
  
  /* Payment Tabs */
  .payment-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 1px solid #e5e7eb;
    padding-bottom: 0;
  }

  .payment-tab {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 12px 20px;
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    color: #6b7280;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    top: 1px;
  }

  .payment-tab:hover {
    color: #374151;
    background: #f9fafb;
  }

  .payment-tab.active {
    color: #6366f1;
    border-bottom-color: #6366f1;
    background: white;
  }

  .payment-tab svg {
    width: 20px;
    height: 16px;
  }

  .payment-tab-more {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 12px 16px;
    background: none;
    border: none;
    color: #9ca3af;
    cursor: pointer;
    transition: all 0.2s;
  }

  .payment-tab-more:hover {
    color: #6b7280;
    background: #f9fafb;
  }

  /* Payment Content */
  .payment-content {
    display: none;
    padding: 20px 0;
  }

  .payment-content.active {
    display: block;
  }

  /* Stripe Card Element Styling */
  #card-element {
    min-height: 40px;
  }

  .StripeElement {
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background: white;
  }

  .StripeElement--focus {
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }

  .StripeElement--invalid {
    border-color: #dc2626;
  }
  
  .payment-methods {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 15px;
    margin-bottom: 30px;
  }
  
  .payment-method {
    border: 2px solid #ddd;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    background: white;
  }
  
  .payment-method:hover {
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
  }
  
  .payment-method.active {
    border-color: #667eea;
    background: #f8f9ff;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
  }
  
  .payment-method input[type="radio"] {
    display: none;
  }
  
  .payment-icon {
    font-size: 32px;
    margin-bottom: 8px;
  }
  
  .payment-label {
    font-size: 14px;
    font-weight: 600;
    color: #333;
  }
  
  .payment-description {
    font-size: 11px;
    color: #888;
    margin-top: 4px;
  }
  
  .payment-details-section {
    display: none;
    margin-top: 20px;
    padding: 25px;
    background: #f8f9ff;
    border-radius: 12px;
    border: 1px solid #e0e7ff;
  }
  
  .payment-details-section.active {
    display: block;
  }
  
  .payment-details-section h3 {
    margin-bottom: 15px;
    color: #333;
    font-size: 16px;
  }
  
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
  }
  
  .btn {
    flex: 1;
    padding: 15px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }
  
  .btn-back {
    background: #f5f5f5;
    color: #333;
  }
  
  .btn-back:hover {
    background: #e0e0e0;
  }
  
  .btn-continue {
    background: #667eea;
    color: white;
  }
  
  .btn-continue:hover {
    background: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }
  
  .btn-place-order {
    width: 100%;
    background: #4CAF50;
    color: white;
  }
  
  .btn-place-order:hover {
    background: #45a049;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
  }
  
  .secure-checkout {
    text-align: center;
    margin-top: 20px;
    color: #666;
    font-size: 13px;
  }
  
  .secure-checkout::before {
    content: 'üîí';
    margin-right: 5px;
  }
  
  .step-content {
    display: none;
  }
  
  .step-content.active {
    display: block;
  }
  
  @media (max-width: 968px) {
    .checkout-content {
      grid-template-columns: 1fr;
    }
    
    .order-summary {
      position: static;
    }
    
    .payment-methods {
      grid-template-columns: 1fr;
    }
    
    .form-row {
      grid-template-columns: 1fr;
    }
    
    .payment-tabs {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .payment-tab {
      flex-shrink: 0;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="checkout-container">
  <div class="checkout-header">
    <h1>Secure Checkout</h1>
    <p>Complete your purchase in just a few steps</p>
  </div>

  <div class="progress-bar">
    <div class="progress-step active" data-step="1">
      <div class="step-circle">1</div>
      <div class="step-label">Shipping</div>
    </div>
    <div class="progress-step" data-step="2">
      <div class="step-circle">2</div>
      <div class="step-label">Payment</div>
    </div>
    <div class="progress-step" data-step="3">
      <div class="step-circle">3</div>
      <div class="step-label">Review</div>
    </div>
  </div>

  <div class="checkout-content">
    <div class="checkout-form">
      <form id="checkoutForm" method="POST">
        {% csrf_token %}
        
        <!-- Step 1: Shipping Information -->
        <div class="step-content active" data-step="1">
          <div class="form-section">
            <h2>Shipping Information</h2>
            <div class="form-row">
              <div class="form-group">
                <label>First Name <span class="required">*</span></label>
                <input type="text" name="first_name" id="first_name" required minlength="3" pattern="[A-Za-z\s]+" title="First name must be at least 3 characters and contain only letters">
                <span class="error-message" id="first_name_error"></span>
              </div>
              <div class="form-group">
                <label>Last Name <span class="required">*</span></label>
                <input type="text" name="last_name" id="last_name" required minlength="3" pattern="[A-Za-z\s]+" title="Last name must be at least 3 characters and contain only letters">
                <span class="error-message" id="last_name_error"></span>
              </div>
            </div>
            
            <div class="form-group">
              <label>Email Address <span class="required">*</span></label>
              <input type="email" name="email" id="email" required pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" title="Please enter a valid email address">
              <span class="error-message" id="email_error"></span>
            </div>
            
            <div class="form-group">
              <label>Phone Number <span class="required">*</span></label>
              <div style="display: flex; gap: 10px;">
                <select name="country_code" id="country_code" required style="width: 120px; flex-shrink: 0;">
                  <option value="+65" data-country="SG">+65 (SG)</option>
                  <option value="+1" data-country="US">+1 (US)</option>
                  <option value="+1" data-country="CA">+1 (CA)</option>
                  <option value="+44" data-country="GB">+44 (GB)</option>
                  <option value="+61" data-country="AU">+61 (AU)</option>
                  <option value="+86" data-country="CN">+86 (CN)</option>
                  <option value="+81" data-country="JP">+81 (JP)</option>
                  <option value="+82" data-country="KR">+82 (KR)</option>
                  <option value="+91" data-country="IN">+91 (IN)</option>
                  <option value="+60" data-country="MY">+60 (MY)</option>
                  <option value="+62" data-country="ID">+62 (ID)</option>
                  <option value="+66" data-country="TH">+66 (TH)</option>
                  <option value="+84" data-country="VN">+84 (VN)</option>
                  <option value="+63" data-country="PH">+63 (PH)</option>
                  <option value="+852" data-country="HK">+852 (HK)</option>
                  <option value="+886" data-country="TW">+886 (TW)</option>
                  <option value="+33" data-country="FR">+33 (FR)</option>
                  <option value="+49" data-country="DE">+49 (DE)</option>
                  <option value="+39" data-country="IT">+39 (IT)</option>
                  <option value="+34" data-country="ES">+34 (ES)</option>
                  <option value="+31" data-country="NL">+31 (NL)</option>
                  <option value="+41" data-country="CH">+41 (CH)</option>
                  <option value="+46" data-country="SE">+46 (SE)</option>
                  <option value="+47" data-country="NO">+47 (NO)</option>
                  <option value="+45" data-country="DK">+45 (DK)</option>
                  <option value="+358" data-country="FI">+358 (FI)</option>
                  <option value="+7" data-country="RU">+7 (RU)</option>
                  <option value="+55" data-country="BR">+55 (BR)</option>
                  <option value="+52" data-country="MX">+52 (MX)</option>
                  <option value="+54" data-country="AR">+54 (AR)</option>
                  <option value="+27" data-country="ZA">+27 (ZA)</option>
                  <option value="+20" data-country="EG">+20 (EG)</option>
                  <option value="+971" data-country="AE">+971 (AE)</option>
                  <option value="+966" data-country="SA">+966 (SA)</option>
                  <option value="+64" data-country="NZ">+64 (NZ)</option>
                </select>
                <input type="tel" name="phone" id="phone" required placeholder="1234 5678" pattern="^\d{4,14}$" title="Please enter a valid phone number (4-14 digits)" style="flex: 1;">
              </div>
              <span class="error-message" id="phone_error"></span>
            </div>
            
            <div class="form-group">
              <label>Street Address <span class="required">*</span></label>
              <input type="text" name="address" id="address" required>
              <span class="error-message" id="address_error"></span>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>City <span class="required">*</span></label>
                <input type="text" name="city" required>
              </div>
              <div class="form-group">
                <label>State/Province <span class="required">*</span></label>
                <input type="text" name="state" required>
              </div>
            </div>
            
            <div class="form-row">
              <div class="form-group">
                <label>ZIP/Postal Code <span class="required">*</span></label>
                <input type="text" name="zip" id="zip" required pattern="^[0-9]{5,6}$" title="Please enter a valid postal code (5-6 digits)">
                <span class="error-message" id="zip_error"></span>
              </div>
              <div class="form-group">
                <label>Country <span class="required">*</span></label>
                <select name="country" required>
                  <option value="">Select Country</option>
                  <option value="AU">Australia</option>
                  <option value="AT">Austria</option>
                  <option value="BE">Belgium</option>
                  <option value="BR">Brazil</option>
                  <option value="CA">Canada</option>
                  <option value="CN">China</option>
                  <option value="DK">Denmark</option>
                  <option value="FI">Finland</option>
                  <option value="FR">France</option>
                  <option value="DE">Germany</option>
                  <option value="HK">Hong Kong</option>
                  <option value="IN">India</option>
                  <option value="ID">Indonesia</option>
                  <option value="IE">Ireland</option>
                  <option value="IT">Italy</option>
                  <option value="JP">Japan</option>
                  <option value="MY">Malaysia</option>
                  <option value="MX">Mexico</option>
                  <option value="NL">Netherlands</option>
                  <option value="NZ">New Zealand</option>
                  <option value="NO">Norway</option>
                  <option value="PH">Philippines</option>
                  <option value="PL">Poland</option>
                  <option value="PT">Portugal</option>
                  <option value="SG">Singapore</option>
                  <option value="ZA">South Africa</option>
                  <option value="KR">South Korea</option>
                  <option value="ES">Spain</option>
                  <option value="SE">Sweden</option>
                  <option value="CH">Switzerland</option>
                  <option value="TW">Taiwan</option>
                  <option value="TH">Thailand</option>
                  <option value="AE">United Arab Emirates</option>
                  <option value="UK">United Kingdom</option>
                  <option value="US">United States</option>
                  <option value="VN">Vietnam</option>
                </select>
              </div>
            </div>
            
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="saveAddress" name="save_address">
                <label for="saveAddress" style="margin: 0;">Save this address for future orders</label>
              </div>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-back" onclick="window.location.href=`{% url 'storefront:home' %}`">
              ‚Üê Back to Cart
            </button>
            <button type="button" class="btn btn-continue" onclick="nextStep()">
              Continue to Payment ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 2: Payment Information -->
        <div class="step-content" data-step="2">
          <div class="form-section">
            <h2>Pay with</h2>
            
            <!-- Payment Method Tabs -->
            <div class="payment-tabs">
              <button class="payment-tab active" data-tab="card">
                <svg width="20" height="16" viewBox="0 0 20 16" fill="currentColor">
                  <rect x="0" y="0" width="20" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/>
                  <rect x="0" y="4" width="20" height="4" fill="currentColor" opacity="0.3"/>
                  <rect x="2" y="10" width="6" height="2" rx="1" fill="currentColor" opacity="0.5"/>
                </svg>
                Card
              </button>
              <button class="payment-tab" data-tab="paynow">
                <img src="{% static 'images/paynow.png' %}" alt="PayNow" style="width: 40px; height: auto;">
                PayNow
              </button>
              <button class="payment-tab" data-tab="applepay">
                <img src="{% static 'images/applepay.png' %}" alt="Apple Pay" style="width: 40px; height: auto;">
                Apple Pay
              </button>
              <button class="payment-tab" data-tab="paypal">
                <img src="{% static 'images/paypal.png' %}" alt="PayPal" style="width: 40px; height: auto;">
                PayPal
              </button>
            </div>

            <!-- Card Payment Section -->
            <div class="payment-content active" id="cardPayment">
              <!-- Stripe Card Element will be inserted here -->
              <div id="card-element" style="padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; background: white; margin-bottom: 16px;">
                <!-- Stripe will inject the card input here -->
              </div>
              <div id="card-errors" role="alert" style="color: #dc2626; font-size: 13px; margin-top: 8px;"></div>
              
              <p style="font-size: 12px; color: #6b7280; margin-top: 12px;">
                <svg width="14" height="14" viewBox="0 0 14 14" fill="#10b981" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
                  <path d="M7 0C3.1 0 0 3.1 0 7s3.1 7 7 7 7-3.1 7-7-3.1-7-7-7zm0 12.5c-3 0-5.5-2.5-5.5-5.5S4 1.5 7 1.5s5.5 2.5 5.5 5.5-2.5 5.5-5.5 5.5z"/>
                  <path d="M5.3 6.3l1.2 1.2 3.2-3.2 1 1-4.2 4.2-2.2-2.2z" fill="#10b981"/>
                </svg>
                Accepts Visa, Mastercard, American Express
              </p>
              <input type="hidden" name="payment_method" value="card">
            </div>

            <!-- PayNow Payment Section -->
            <div class="payment-content" id="paynowPayment">
              <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                <div style="text-align: center; margin-bottom: 20px;">
                  <div style="background: white; width: 200px; height: 200px; margin: 0 auto; border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <svg width="160" height="160" viewBox="0 0 160 160" fill="none">
                      <rect width="160" height="160" fill="white"/>
                      <g opacity="0.15">
                        <rect x="20" y="20" width="20" height="20" fill="#1e40af"/>
                        <rect x="60" y="20" width="20" height="20" fill="#1e40af"/>
                        <rect x="100" y="20" width="20" height="20" fill="#1e40af"/>
                        <rect x="140" y="20" width="20" height="20" fill="#1e40af"/>
                        <rect x="20" y="60" width="20" height="20" fill="#1e40af"/>
                        <rect x="100" y="60" width="20" height="20" fill="#1e40af"/>
                        <rect x="140" y="60" width="20" height="20" fill="#1e40af"/>
                        <rect x="20" y="100" width="20" height="20" fill="#1e40af"/>
                        <rect x="60" y="100" width="20" height="20" fill="#1e40af"/>
                        <rect x="140" y="100" width="20" height="20" fill="#1e40af"/>
                        <rect x="20" y="140" width="20" height="20" fill="#1e40af"/>
                        <rect x="60" y="140" width="20" height="20" fill="#1e40af"/>
                        <rect x="100" y="140" width="20" height="20" fill="#1e40af"/>
                      </g>
                      <text x="80" y="85" text-anchor="middle" font-family="Arial" font-size="12" fill="#64748b">QR Code</text>
                      <text x="80" y="100" text-anchor="middle" font-family="Arial" font-size="10" fill="#94a3b8">Scan to Pay</text>
                    </svg>
                  </div>
                  <p style="margin-top: 12px; color: #64748b; font-size: 13px;">
                    Scan with your banking app to complete payment
                  </p>
                </div>
                
                <div style="background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                    <span style="color: #64748b; font-size: 13px;">PayNow UEN</span>
                    <span style="color: #1e293b; font-weight: 600; font-size: 14px;">201234567A</span>
                  </div>
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #64748b; font-size: 13px;">Recipient</span>
                    <span style="color: #1e293b; font-weight: 600; font-size: 14px;">AuroraMart Pte Ltd</span>
                  </div>
                </div>
                
                <p style="font-size: 12px; color: #64748b; display: flex; align-items: start; gap: 6px;">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="#3b82f6" style="flex-shrink: 0; margin-top: 2px;">
                    <circle cx="8" cy="8" r="7" stroke="currentColor" stroke-width="1.5" fill="none"/>
                    <path d="M8 4v4.5l3 1.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                  </svg>
                  <span>Payment is instant. QR code will be generated after you proceed to review.</span>
                </p>
              </div>
              <input type="hidden" name="payment_method" value="paynow">
            </div>

            <!-- Apple Pay Section -->
            <div class="payment-content" id="applepayPayment">
              <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 32px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <div style="margin-bottom: 20px;">
                  <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                    <rect width="80" height="80" rx="16" fill="#000000"/>
                    <path d="M48 22c-1.5 0-3 .6-4.2 1.7-.9.9-1.5 2.2-1.5 3.6 0 .3 0 .5.2.9 1.7.2 3.2-.4 4.4-1.5.9-.9 1.5-2.2 1.5-3.6-.2 0-.3 0-.4-.2-.5-.5-1.3-.9-1.9-.9zM39 24c-2.5 0-4.6 1.5-5.7 1.5-1.1 0-3-1.3-5-1.3-2.5 0-4.7 1.5-6.1 3.8-1.7 3-2.3 8.8 1.3 14 1.7 2.5 4 5.3 6.9 5.3 1.9 0 2.7-1.1 5.1-1.1s3 1.1 5.1 1.1c2.9 0 5-2.7 6.9-5.1 1.1-1.7 1.9-3.6 2.3-5.5-4.4-1.7-5.1-8.2-.8-10.5-1.7-2.5-4.4-4-7.3-4h-.7z" fill="white"/>
                  </svg>
                </div>
                <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px; font-weight: 600;">Apple Pay</h3>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
                  Fast, secure checkout with Face ID or Touch ID
                </p>
                
                <div style="background: white; padding: 16px; border-radius: 8px; text-align: left;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">Secure biometric authentication</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">No card details needed</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">One-tap checkout</span>
                  </div>
                </div>
              </div>
              <input type="hidden" name="payment_method" value="applepay">
            </div>

            <!-- PayPal Section -->
            <div class="payment-content" id="paypalPayment">
              <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 32px; border-radius: 12px; border: 1px solid #e2e8f0; text-align: center;">
                <div style="margin-bottom: 20px;">
                  <svg width="80" height="80" viewBox="0 0 80 80" fill="none">
                    <rect width="80" height="80" rx="16" fill="#0070ba"/>
                    <path d="M54 28c.8 4-.5 6.8-3.2 9.2-3 2.5-7 3.7-11.2 3.7h-4.5l-2 12.5h-6.2L32.5 23h11c4.2 0 7.2 1 9 3 1.5 1.5 2.2 3.5 1.5 6.5z" fill="white"/>
                    <path d="M47 21c1 4.2-.5 7-3.5 9.7-3 2.5-7.2 3.7-11.7 3.7h-4.5l-2.2 13h-6.2L24 21h11.5c4.2 0 7.5 1 9.2 3.2 1.5 1.5 2.2 3.7 1.8 6.8z" fill="white" opacity="0.7"/>
                  </svg>
                </div>
                <h3 style="font-size: 18px; color: #1e293b; margin-bottom: 8px; font-weight: 600;">PayPal</h3>
                <p style="color: #64748b; font-size: 14px; margin-bottom: 20px;">
                  You'll be redirected to PayPal to complete your purchase
                </p>
                
                <div style="background: white; padding: 16px; border-radius: 8px; text-align: left;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">Buyer protection included</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">Pay with balance or linked cards</span>
                  </div>
                  <div style="display: flex; align-items: center; gap: 8px;">
                    <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
                      <circle cx="9" cy="9" r="9" fill="#dcfce7"/>
                      <path d="M6 9l2 2 4-4" stroke="#10b981" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span style="font-size: 13px; color: #475569;">Fast & secure checkout</span>
                  </div>
                </div>
              </div>
              <input type="hidden" name="payment_method" value="paypal">
            </div>
          </div>

          <div class="form-actions" style="margin-top: 30px;">
            <button type="button" class="btn btn-secondary" onclick="prevStep()">
              ‚Üê Back to Shipping
            </button>
            <button type="button" class="btn btn-primary" onclick="nextStep()">
              Review Order ‚Üí
            </button>
          </div>
        </div>

        <!-- Step 3: Review Order -->
        <div class="step-content" data-step="3">
          <div class="form-section">
            <h2>Review Your Order</h2>
            <div style="background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="margin-bottom: 15px; color: #333;">Shipping Address</h3>
              <p style="color: #666; line-height: 1.6;" id="reviewAddress">
                <!-- Will be filled by JavaScript -->
              </p>
            </div>
            
            <div style="background: #f0fdf4; padding: 20px; border-radius: 8px; border: 2px solid #86efac;">
              <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2">
                  <rect x="2" y="5" width="20" height="14" rx="2"/>
                  <path d="M2 10h20"/>
                </svg>
                Payment Method
              </h3>
              <div id="reviewPayment" style="font-size: 15px;">
                <!-- Will be filled by JavaScript -->
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="agreeTerms" required>
              <label for="agreeTerms" style="margin: 0;">
                I agree to the <a href="#" style="color: #667eea;">Terms & Conditions</a>
              </label>
            </div>
          </div>
          
          <div class="action-buttons">
            <button type="button" class="btn btn-back" onclick="prevStep()">
              ‚Üê Back
            </button>
            <button type="submit" class="btn btn-place-order">
              Place Order
            </button>
          </div>
          
          <div class="secure-checkout">
            Your payment information is secure and encrypted
          </div>
        </div>
      </form>
    </div>

    <div class="order-summary">
      <h2>Order Summary</h2>
      
      <div class="cart-items">
        {% if cart_items %}
          {% for item in cart_items %}
          <div class="cart-item">
            <div class="item-image">
              {% if item.product.image %}
                <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;">
              {% else %}
                <svg viewBox="0 0 24 24" fill="none" style="width: 60px; height: 60px; opacity: 0.15;">
                  <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#667eea"/>
                </svg>
              {% endif %}
            </div>
            <div class="item-details">
              <div class="item-name">{{ item.product.name }}</div>
              <div class="item-quantity">Quantity: {{ item.quantity }}</div>
              <div class="item-price">${{ item.total_price }}</div>
            </div>
          </div>
          {% endfor %}
        {% else %}
          <div class="cart-item">
            <div class="item-image">
              <svg viewBox="0 0 24 24" fill="none" style="width: 60px; height: 60px; opacity: 0.15;">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#667eea"/>
              </svg>
            </div>
            <div class="item-details">
              <div class="item-name">Sample Product</div>
              <div class="item-quantity">Quantity: 1</div>
              <div class="item-price">$29.99</div>
            </div>
          </div>
          <div class="cart-item">
            <div class="item-image">
              <svg viewBox="0 0 24 24" fill="none" style="width: 60px; height: 60px; opacity: 0.15;">
                <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" fill="#667eea"/>
              </svg>
            </div>
            <div class="item-details">
              <div class="item-name">Another Product</div>
              <div class="item-quantity">Quantity: 2</div>
              <div class="item-price">$59.98</div>
            </div>
          </div>
        {% endif %}
      </div>
      
      {% if promo_code %}
      <div class="promo-code" style="background: #e8f5e9; border: 1px solid #4CAF50; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 8px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#4CAF50" stroke-width="2">
            <polyline points="20 6 9 17 4 12"></polyline>
          </svg>
          <span style="color: #2e7d32; font-weight: 500;">Promo code "{{ promo_code }}" applied</span>
        </div>
        <a href="{% url 'storefront:cart' %}" style="color: #2e7d32; text-decoration: none; font-size: 14px;">Change</a>
      </div>
      {% else %}
      <div class="promo-code">
        <span style="color: #666; font-size: 14px;">Apply promo code on cart page</span>
      </div>
      {% endif %}
      
      <div class="summary-row">
        <span>Subtotal</span>
        <span id="subtotal">${{ subtotal|default:"89.97" }}</span>
      </div>
      {% if shipping > 0 %}
      <div class="summary-row" id="shippingRow">
        <span>Shipping</span>
        <span id="shipping">${{ shipping|default:"9.99" }}</span>
      </div>
      {% endif %}
      <div class="summary-row">
        <span>Tax</span>
        <span id="tax">${{ tax|default:"8.00" }}</span>
      </div>
      {% if discount %}
      <div class="summary-row" id="discountRow" style="color: #4CAF50;">
        <span>Discount{% if promo_code %} ({{ promo_code }}){% endif %}</span>
        <span id="discount">-${{ discount }}</span>
      </div>
      {% endif %}
      <div class="summary-row total">
        <span>Total</span>
        <span id="total">${{ total|default:"107.96" }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Stripe.js Library -->
<script src="https://js.stripe.com/v3/"></script>

<script>
  let currentStep = 1;

  // Initialize Stripe
  const stripe = Stripe('pk_test_51QRxmZP3lN8WLMKZQF3xFxUj8QgXxV9zMxGxKxPxAxBxCxDxExFxGxHxIxJxKxLxMxN'); // Replace with your actual publishable key
  const elements = stripe.elements();
  
  // Create card element
  const cardElement = elements.create('card', {
    style: {
      base: {
        fontSize: '16px',
        color: '#32325d',
        fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
        '::placeholder': {
          color: '#aab7c4'
        }
      },
      invalid: {
        color: '#dc2626',
        iconColor: '#dc2626'
      }
    }
  });
  
  // Mount card element when page loads
  document.addEventListener('DOMContentLoaded', function() {
    cardElement.mount('#card-element');
    
    // Handle real-time validation errors from card element
    cardElement.on('change', function(event) {
      const displayError = document.getElementById('card-errors');
      if (event.error) {
        displayError.textContent = event.error.message;
      } else {
        displayError.textContent = '';
      }
    });
  });

  // Payment tab switching
  document.querySelectorAll('.payment-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      // Remove active class from all tabs
      document.querySelectorAll('.payment-tab').forEach(t => t.classList.remove('active'));
      // Add active class to clicked tab
      this.classList.add('active');
      
      // Hide all payment contents
      document.querySelectorAll('.payment-content').forEach(content => {
        content.classList.remove('active');
      });
      
      // Show selected payment content
      const tabType = this.getAttribute('data-tab');
      let contentId;
      let paymentMethodValue;
      
      if (tabType === 'card') {
        contentId = 'cardPayment';
        paymentMethodValue = 'card';
      } else if (tabType === 'paynow') {
        contentId = 'paynowPayment';
        paymentMethodValue = 'paynow';
      } else if (tabType === 'applepay') {
        contentId = 'applepayPayment';
        paymentMethodValue = 'applepay';
      } else if (tabType === 'paypal') {
        contentId = 'paypalPayment';
        paymentMethodValue = 'paypal';
      }
      
      document.getElementById(contentId).classList.add('active');
      
      // Update all hidden payment_method inputs
      document.querySelectorAll('input[name="payment_method"]').forEach(input => {
        input.value = paymentMethodValue;
      });
      
      // Clear payment method error border if exists
      const paymentSection = document.querySelector('.payment-methods');
      if (paymentSection) {
        paymentSection.style.border = 'none';
      }
    });
  });

  // Real-time validation functions
  function validateName(input, errorId, fieldName) {
    const value = input.value.trim();
    const errorElement = document.getElementById(errorId);
    
    if (value.length === 0) {
      input.classList.add('error');
      errorElement.textContent = `${fieldName} is required`;
      return false;
    } else if (value.length < 3) {
      input.classList.add('error');
      errorElement.textContent = `${fieldName} must be at least 3 characters`;
      return false;
    } else if (!/^[A-Za-z\s]+$/.test(value)) {
      input.classList.add('error');
      errorElement.textContent = `${fieldName} must contain only letters`;
      return false;
    } else {
      input.classList.remove('error');
      errorElement.textContent = '';
      return true;
    }
  }

  function validateEmail(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById('email_error');
    const emailPattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$/i;
    
    if (value.length === 0) {
      input.classList.add('error');
      errorElement.textContent = 'Email is required';
      return false;
    } else if (!emailPattern.test(value)) {
      input.classList.add('error');
      errorElement.textContent = 'Please enter a valid email address';
      return false;
    } else {
      input.classList.remove('error');
      errorElement.textContent = '';
      return true;
    }
  }

  function validatePhone(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById('phone_error');
    const phonePattern = /^\d{4,14}$/;
    
    if (value.length === 0) {
      input.classList.add('error');
      errorElement.textContent = 'Phone number is required';
      return false;
    } else if (!phonePattern.test(value)) {
      input.classList.add('error');
      errorElement.textContent = 'Please enter a valid phone number (4-14 digits)';
      return false;
    } else {
      input.classList.remove('error');
      errorElement.textContent = '';
      return true;
    }
  }

  function validatePostalCode(input) {
    const value = input.value.trim();
    const errorElement = document.getElementById('zip_error');
    const postalPattern = /^[0-9]{5,6}$/;
    
    if (value.length === 0) {
      input.classList.add('error');
      errorElement.textContent = 'Postal code is required';
      return false;
    } else if (!postalPattern.test(value)) {
      input.classList.add('error');
      errorElement.textContent = 'Please enter a valid postal code (5-6 digits)';
      return false;
    } else {
      input.classList.remove('error');
      errorElement.textContent = '';
      return true;
    }
  }

  // Add event listeners for real-time validation
  document.addEventListener('DOMContentLoaded', function() {
    const firstNameInput = document.getElementById('first_name');
    const lastNameInput = document.getElementById('last_name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const zipInput = document.getElementById('zip');

    if (firstNameInput) {
      firstNameInput.addEventListener('blur', () => validateName(firstNameInput, 'first_name_error', 'First name'));
      firstNameInput.addEventListener('input', () => validateName(firstNameInput, 'first_name_error', 'First name'));
    }

    if (lastNameInput) {
      lastNameInput.addEventListener('blur', () => validateName(lastNameInput, 'last_name_error', 'Last name'));
      lastNameInput.addEventListener('input', () => validateName(lastNameInput, 'last_name_error', 'Last name'));
    }

    if (emailInput) {
      emailInput.addEventListener('blur', () => validateEmail(emailInput));
      emailInput.addEventListener('input', () => validateEmail(emailInput));
    }

    if (phoneInput) {
      phoneInput.addEventListener('blur', () => validatePhone(phoneInput));
      phoneInput.addEventListener('input', () => validatePhone(phoneInput));
    }

    if (zipInput) {
      zipInput.addEventListener('blur', () => validatePostalCode(zipInput));
      zipInput.addEventListener('input', () => validatePostalCode(zipInput));
    }

    // Add form submission validation
    const checkoutForm = document.getElementById('checkoutForm');
    if (checkoutForm) {
      checkoutForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validate all required fields
        if (!validateAllFields()) {
          alert('Please fill in all required fields correctly before placing your order.');
          return false;
        }
        
        // If validation passes, submit the form
        this.submit();
      });
    }
  });

  function validateAllFields() {
    const form = document.getElementById('checkoutForm');
    let isValid = true;
    let firstInvalidField = null;

    // Get all required inputs and selects
    const requiredFields = form.querySelectorAll('input[required], select[required]');
    
    requiredFields.forEach(field => {
      // Skip radio buttons if any in the group is checked
      if (field.type === 'radio') {
        const radioGroup = form.querySelectorAll(`input[name="${field.name}"]`);
        const isChecked = Array.from(radioGroup).some(radio => radio.checked);
        if (!isChecked && field.name === 'payment_method') {
          isValid = false;
          if (!firstInvalidField) firstInvalidField = field;
          // Highlight payment section
          document.querySelector('.payment-methods').style.border = '2px solid #f44336';
        } else if (isChecked && field.name === 'payment_method') {
          document.querySelector('.payment-methods').style.border = 'none';
        }
        return;
      }

      // Skip checkbox for terms
      if (field.type === 'checkbox') {
        if (!field.checked) {
          isValid = false;
          if (!firstInvalidField) firstInvalidField = field;
          field.parentElement.style.color = '#f44336';
        } else {
          field.parentElement.style.color = '';
        }
        return;
      }

      // Check if field is empty
      if (!field.value || field.value.trim() === '') {
        isValid = false;
        field.classList.add('error');
        if (!firstInvalidField) firstInvalidField = field;
        
        // Add error message if there's an error span
        const fieldName = field.name.replace('_', ' ');
        const errorSpan = document.getElementById(field.id + '_error');
        if (errorSpan) {
          errorSpan.textContent = `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} is required`;
        }
      } else {
        field.classList.remove('error');
      }
    });

    // Specific validation for fields with custom validators
    const firstNameInput = document.getElementById('first_name');
    const lastNameInput = document.getElementById('last_name');
    const emailInput = document.getElementById('email');
    const phoneInput = document.getElementById('phone');
    const zipInput = document.getElementById('zip');

    if (firstNameInput && firstNameInput.value) {
      const isFirstNameValid = validateName(firstNameInput, 'first_name_error', 'First name');
      if (!isFirstNameValid) {
        isValid = false;
        if (!firstInvalidField) firstInvalidField = firstNameInput;
      }
    }

    if (lastNameInput && lastNameInput.value) {
      const isLastNameValid = validateName(lastNameInput, 'last_name_error', 'Last name');
      if (!isLastNameValid) {
        isValid = false;
        if (!firstInvalidField) firstInvalidField = lastNameInput;
      }
    }

    if (emailInput && emailInput.value) {
      const isEmailValid = validateEmail(emailInput);
      if (!isEmailValid) {
        isValid = false;
        if (!firstInvalidField) firstInvalidField = emailInput;
      }
    }

    if (phoneInput && phoneInput.value) {
      const isPhoneValid = validatePhone(phoneInput);
      if (!isPhoneValid) {
        isValid = false;
        if (!firstInvalidField) firstInvalidField = phoneInput;
      }
    }

    if (zipInput && zipInput.value) {
      const isPostalValid = validatePostalCode(zipInput);
      if (!isPostalValid) {
        isValid = false;
        if (!firstInvalidField) firstInvalidField = zipInput;
      }
    }

    // Scroll to first invalid field
    if (firstInvalidField) {
      firstInvalidField.scrollIntoView({ behavior: 'smooth', block: 'center' });
      firstInvalidField.focus();
    }

    return isValid;
  }

  function nextStep() {
    if (validateStep(currentStep)) {
      document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
      document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
      
      document.querySelector(`[data-step="${currentStep}"]`).classList.add('completed');
      
      currentStep++;
      
      document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
      document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
      
      if (currentStep === 3) {
        updateReview();
      }
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  }

  function prevStep() {
    document.querySelector(`[data-step="${currentStep}"]`).classList.remove('active');
    document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.remove('active');
    
    currentStep--;
    
    document.querySelector(`[data-step="${currentStep}"]`).classList.add('active');
    document.querySelector(`.step-content[data-step="${currentStep}"]`).classList.add('active');
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function validateStep(step) {
    if (step === 1) {
      // Validate shipping information
      const firstNameInput = document.getElementById('first_name');
      const lastNameInput = document.getElementById('last_name');
      const emailInput = document.getElementById('email');
      const phoneInput = document.getElementById('phone');
      const addressInput = document.getElementById('address');
      const zipInput = document.getElementById('zip');

      const isFirstNameValid = validateName(firstNameInput, 'first_name_error', 'First name');
      const isLastNameValid = validateName(lastNameInput, 'last_name_error', 'Last name');
      const isEmailValid = validateEmail(emailInput);
      const isPhoneValid = validatePhone(phoneInput);
      const isPostalValid = validatePostalCode(zipInput);

      // Check if address is filled
      if (!addressInput.value.trim()) {
        addressInput.classList.add('error');
        document.getElementById('address_error').textContent = 'Address is required';
        return false;
      } else {
        addressInput.classList.remove('error');
        document.getElementById('address_error').textContent = '';
      }

      // Check all other required fields in step 1
      const stepContent = document.querySelector(`.step-content[data-step="1"]`);
      const requiredFields = stepContent.querySelectorAll('input[required], select[required]');
      let allFilled = true;
      
      requiredFields.forEach(field => {
        if (!field.value || field.value.trim() === '') {
          field.classList.add('error');
          allFilled = false;
        }
      });

      if (!isFirstNameValid || !isLastNameValid || !isEmailValid || !isPhoneValid || !isPostalValid || !allFilled) {
        alert('Please fill in all required fields and fix validation errors before proceeding');
        return false;
      }

      return true;
    }

    // Validation for step 2 (Payment)
    if (step === 2) {
      // Check if any payment tab is active
      const activeTab = document.querySelector('.payment-tab.active');
      
      if (!activeTab) {
        alert('Please select a payment method before proceeding');
        // Highlight payment section
        const paymentTabs = document.querySelector('.payment-tabs');
        if (paymentTabs) {
          paymentTabs.style.border = '2px solid #f44336';
          paymentTabs.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return false;
      } else {
        // Remove error styling
        const paymentTabs = document.querySelector('.payment-tabs');
        if (paymentTabs) {
          paymentTabs.style.border = 'none';
        }
      }

      // Check if card details are filled if card payment is selected
      const tabType = activeTab.getAttribute('data-tab');
      if (tabType === 'card') {
        // For Stripe, we just need to check if the card element has content
        // The validation happens through Stripe's own validation
        const cardElement = document.getElementById('card-element');
        if (cardElement && !cardElement.classList.contains('StripeElement--complete')) {
          alert('Please fill in your card details');
          cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          return false;
        }
      }

      return true;
    }

    // Default validation for other steps
    const stepContent = document.querySelector(`.step-content[data-step="${step}"]`);
    const inputs = stepContent.querySelectorAll('input[required], select[required]');
    
    for (let input of inputs) {
      // Skip radio buttons - check if any in the group is selected
      if (input.type === 'radio') {
        const radioName = input.name;
        const radioGroup = stepContent.querySelectorAll(`input[name="${radioName}"]`);
        const isChecked = Array.from(radioGroup).some(radio => radio.checked);
        if (!isChecked) {
          alert(`Please select a ${radioName.replace('_', ' ')}`);
          return false;
        }
        continue;
      }

      // Skip checkbox for terms
      if (input.type === 'checkbox') {
        if (!input.checked) {
          alert('Please agree to the Terms & Conditions');
          input.focus();
          return false;
        }
        continue;
      }

      if (!input.value || input.value.trim() === '') {
        input.classList.add('error');
        input.focus();
        alert('Please fill in all required fields');
        return false;
      }
    }
    return true;
  }

  function updateReview() {
    const form = document.getElementById('checkoutForm');
    const countryCode = form.country_code.value;
    const phoneNumber = form.phone.value;
    const fullPhone = `${countryCode} ${phoneNumber}`;
    
    const address = `${form.first_name.value} ${form.last_name.value}<br>
                     ${form.address.value}<br>
                     ${form.city.value}, ${form.state.value} ${form.zip.value}<br>
                     ${form.country.options[form.country.selectedIndex].text}<br>
                     ${fullPhone}`;
    
    document.getElementById('reviewAddress').innerHTML = address;
    
    // Get active payment tab
    const activeTab = document.querySelector('.payment-tab.active');
    let paymentText = '';
    let paymentIcon = '';
    
    if (activeTab) {
      const tabType = activeTab.getAttribute('data-tab');
      
      if (tabType === 'card') {
        paymentIcon = '<svg width="40" height="32" viewBox="0 0 20 16" fill="currentColor" style="color: #667eea;"><rect x="0" y="0" width="20" height="16" rx="2" fill="none" stroke="currentColor" stroke-width="1.5"/><rect x="0" y="4" width="20" height="4" fill="currentColor" opacity="0.3"/><rect x="2" y="10" width="6" height="2" rx="1" fill="currentColor" opacity="0.5"/></svg>';
        paymentText = 'Credit/Debit Card';
      } else if (tabType === 'paynow') {
        paymentIcon = '<img src="{% static "images/paynow.png" %}" alt="PayNow" style="width: 50px; height: auto;">';
        paymentText = 'PayNow (Instant Bank Transfer)';
      } else if (tabType === 'paypal') {
        paymentIcon = '<img src="{% static "images/paypal.png" %}" alt="PayPal" style="width: 50px; height: auto;">';
        paymentText = 'PayPal';
      } else if (tabType === 'applepay') {
        paymentIcon = '<img src="{% static "images/applepay.png" %}" alt="Apple Pay" style="width: 50px; height: auto;">';
        paymentText = 'Apple Pay';
      }
      
      document.getElementById('reviewPayment').innerHTML = `
        <div style="display: flex; align-items: center; gap: 12px;">
          <div style="line-height: 1;">${paymentIcon}</div>
          <div>
            <div style="font-weight: 600; color: #1f2937; font-size: 16px;">${paymentText}</div>
            <div style="font-size: 13px; color: #6b7280; margin-top: 2px;">Payment will be processed securely</div>
          </div>
        </div>
      `;
    } else {
      document.getElementById('reviewPayment').innerHTML = '<span style="color: #f44336; font-weight: 500;">‚ö†Ô∏è No payment method selected</span>';
    }
  }

  // Payment method selection
  document.querySelectorAll('.payment-method').forEach(method => {
    method.addEventListener('click', function() {
      // Update active state
      document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('active'));
      this.classList.add('active');
      this.querySelector('input[type="radio"]').checked = true;
      
      // Hide all payment details sections
      document.querySelectorAll('.payment-details-section').forEach(section => {
        section.classList.remove('active');
      });
      
      // Show the relevant payment details section
      const paymentType = this.getAttribute('data-payment');
      const detailsSection = document.getElementById(paymentType + 'Details');
      if (detailsSection) {
        detailsSection.classList.add('active');
      }
    });
  });

  // Card number formatting
  document.querySelector('input[name="card_number"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\s/g, '');
    let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
    e.target.value = formattedValue;
  });

  // Expiry date formatting
  document.querySelector('input[name="expiry"]')?.addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length >= 2) {
      value = value.slice(0, 2) + '/' + value.slice(2, 4);
    }
    e.target.value = value;
  });
  
</script>
{% endblock %}